<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Distribuir Atributos - pyRPG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Distribua seus Atributos ({{ titulo }})</h1>
        <p>Valores rolados: <strong>{{ valores|sort|join(', ') }}</strong></p>

        {% if erro %}
            <p class="erro">{{ erro }}</p>
        {% endif %}

        <form action="{{ url_for('distribuir_atributos') }}" method="post" id="form-atributos">
            {% set nomes_atributos = ["forca", "destreza", "constituicao", "inteligencia", "sabedoria", "carisma"] %}

            {% for nome in nomes_atributos %}
            <div>
                <label for="{{ nome }}">{{ nome.capitalize() }}:</label>
                <select name="{{ nome }}" class="atributo-select" required>
                    <option value="" disabled selected>Escolha um valor</option>
                    {% for valor in valores %}
                    <option value="{{ valor }}">{{ valor }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}

            <button type="submit">Finalizar Personagem</button>
        </form>
    </div>

    <script>
        const form = document.getElementById('form-atributos');
        const selects = document.querySelectorAll('.atributo-select');
        
        // Passa os valores rolados do Jinja2 para o JavaScript
        const valoresRolados = {{ valores|tojson }};

        // Cria um mapa de contagem para os valores rolados originais
        const contagemOriginal = valoresRolados.reduce((acc, val) => {
            acc[val] = (acc[val] || 0) + 1;
            return acc;
        }, {});

        form.addEventListener('change', () => {
            // Pega todos os valores atualmente selecionados
            const valoresSelecionados = Array.from(selects)
                                             .map(s => s.value)
                                             .filter(v => v !== "");

            // Cria um mapa de contagem para os valores selecionados
            const contagemSelecionados = valoresSelecionados.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});

            // Itera sobre cada menu <select> para atualizar as opções
            selects.forEach(select => {
                const selecaoAtual = select.value;

                Array.from(select.options).forEach(option => {
                    if (option.value === "") return; // Pula a opção "Escolha um valor"

                    const valorOpcao = option.value;
                    const selecionadoMuitasVezes = (contagemSelecionados[valorOpcao] || 0) >= (contagemOriginal[valorOpcao] || 0);

                    // Desabilita a opção se ela já foi selecionada o número máximo de vezes,
                    // a menos que seja a seleção atual deste próprio menu.
                    if (selecionadoMuitasVezes && valorOpcao !== selecaoAtual) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                });
            });
        });
    </script>
</body>
</html>